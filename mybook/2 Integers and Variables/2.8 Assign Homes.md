# 2.8 Assign Homes

However, with some care we can generate shorter sequences of instructions. Suppose that one or more of the arguments of the addition is the same variable as the left- hand side of the assignment. Then the assignment statement can be translated into a single addq instruction, as follows.

var = (+ atm1 var); ⇒ addq arg1, var

On the other hand, if atm2 is not the same variable as the left-hand side, then we can move arg1 into the left-hand var and then add arg2 to var.

var = (+ atm1 atm2); ⇒ movq arg1, var addq arg2, var

The read operation does not have a direct counterpart in x86 assembly, so we provide this functionality with the function read_int in the file runtime.c, written in C (Kernighan and Ritchie 1988). In general, we refer to all the functionality in this file as the runtime system, or simply the runtime for short. When compiling your generated x86 assembly code, you need to compile runtime.c to runtime.o (an object file, using gcc with option -c) and link it into the executable. For our purposes of code generation, all you need to do is translate an assignment of read into a call to the read_int function followed by a move from rax to the left-hand side variable. (The return value of a function is placed in rax.)

var = (read); ⇒ callq read_int movq %rax, var

There are two cases for the tail nonterminal: Return and Seq. Regarding Return, we recommend treating it as an assignment to the rax register followed by a jump to the label conclusion. Later, in Section 2.10, we discuss the generation of the conclusion block. In the meantime, the interpreter for x86Var recognizes a jump to conclusion as the end of the program. For (Seq s t), you can translate the statement s and tail t recursively and then append the resulting instructions.

Exercise 2.5 Implement the select_instructions pass in compiler.rkt. Create three new example programs that are designed to exercise all the interesting cases in this pass. In the run-tests.rkt script, add the following entry to the list of passes and then run the script to test your compiler.

(list "instruction selection" select_instructions interp_pseudo-x86-0)

2.8 Assign Homes

The assign_homes pass compiles x86Var programs to x86Var programs that no longer use program variables. Thus, the assign_homes pass is responsible for placing all the program variables in registers or on the stack. For runtime efficiency, it is better to place variables in registers, but because there are only sixteen registers, some


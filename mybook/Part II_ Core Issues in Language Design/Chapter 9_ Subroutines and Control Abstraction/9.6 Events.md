# 9.6 Events

**456**
Chapter 9* Subroutines and Control Abstraction*

9.5.3** Implementation of Iterators**

Given an implementation of coroutines, iterators are almost trivial: one coroutine
is used to represent the main program; a second is used to represent the iterator.
Additional coroutines may be needed if iterators nest.

**IN MORE DEPTH**

Additional details appear on the companion site. As it turns out, coroutines are
overkill for iterator implementation. Most compilers use one of two simpler alter-
natives. The ﬁrst of these keeps all state in a single stack, but sometimes executes
in a frame other than the topmost. The second employs a compile-time code
transformation to replace true iterators, transparently, with equivalent iterator
objects.

9.5.4** Discrete Event Simulation**

One of the most important applications of coroutines (and the one for which
Simula was designed and named) is* discrete event simulation*. Simulation in gen-
eral refers to any process in which we create an abstract model of some real-world
system, and then experiment with the model in order to infer properties of the
real-world system. Simulation is desirable when experimentation with the real
world would be complicated, dangerous, expensive, or otherwise impractical. A
*discrete event* simulation is one in which the model is naturally expressed in terms
of events (typically interactions among various interesting objects) that happen
at speciﬁc times. Discrete event simulation is usually not appropriate for contin-
uous processes, such as the growth of crystals or the ﬂow of water over a surface,
unless these processes are captured at the level of individual particles.

**IN MORE DEPTH**

On the companion site we consider a trafﬁc simulation, in which events model
interactions among automobiles, intersections, and trafﬁc lights. We use a sep-
arate coroutine for each trip to be taken by car. At any given time we run the
coroutine with the earliest expected arrival time at an upcoming intersection. We
keep inactive coroutines in a priority queue ordered by those arrival times.

## 9.6

**Events**
An* event* is something to which a running program (a process) needs to respond,
but which occurs outside the program, at an unpredictable time. Events are com-
monly caused by inputs to a graphical user interface (GUI) system: keystrokes,

return

return from
interrupt


![Figure 9.5 Signal delivery...](images/page_491_vector_313.png)
*Figure 9.5 Signal delivery through a trampoline. When an interrupt occurs (or when another process performs an operation that should appear as an event), the main program may be at an arbitrary place in its code. The kernel saves state and invokes a trampoline routine that in turn calls the event handler through the normal calling sequence. After the event handler returns, the trampoline restores the saved state and returns to where the main program left off.*

to the signal trampoline. Immediately before jumping back to the original pro-
gram code, the trampoline performs a kernel call to reenable signals. Depending
on the details of the operating system, the kernel may buffer some modest num-
ber of signals while they are disabled, and deliver them once the handler reenables
them.
■
In practice, most event handlers need to share data structures with the main
program (otherwise, how would they get the program to do anything interesting
in response to the event?). We must take care to make sure neither the handler
nor the main program ever sees these shared structures in an inconsistent state.
Speciﬁcally, we must prevent a handler from looking at data when the main pro-
gram is halfway through modifying it, or modifying data when the main program
is halfway through reading it. The typical solution is to* synchronize* access to such
shared structures by bracketing blocks of code in the main program with kernel
calls that disable and reenable signals. We will use a similar mechanism to im-
plement threads on top of coroutines in Section 13.2.4. More general forms of
synchronization will appear in Section 13.3.


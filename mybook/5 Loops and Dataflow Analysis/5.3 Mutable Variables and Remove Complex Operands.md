# 5.3 Mutable Variables and Remove Complex Operands

5.3 Mutable Variables and Remove Complex Operands

There is a subtle interaction between the remove_complex_operands pass, the addition of set!, and the left-to-right order of evaluation of Racket. Consider the following example:

```
(let ([x 2])
(+ x (begin (set! x 40) x)))
```

The result of this program is 42 because the first read from x produces 2 and the second produces 40. However, if we naively apply the remove_complex_operands pass to this example we obtain the following program whose result is 80!

```
(let ([x 2])
(let ([tmp (begin (set! x 40) x)])
(+ x tmp)))
```

The problem is that with mutable variables, the ordering between reads and writes is important, and the remove_complex_operands pass moved the set! to happen before the first read of x. We recommend solving this problem by giving special treatment to reads from mutable variables, that is, variables that occur on the left-hand side of a set!. We mark each read from a mutable variable with the form get! (GetBang in abstract syntax) to indicate that the read operation is effectful in that it can produce different results at different points in time. Letâ€™s apply this idea to the following variation that also involves a variable that is not mutated:

```
(let ([x 2])
(let ([y 0])
(+ y (+ x (begin (set! x 40) x)))))
```

We first analyze this program to discover that variable x is mutable but y is not. We then transform the program as follows, replacing each occurrence of x with (get! x):

```
(let ([x 2])
(let ([y 0])
(+ y (+ (get! x) (begin (set! x 40) (get! x))))))
```

Now that we have a clear distinction between reads from mutable and immutable variables, we can apply the remove_complex_operands pass, where reads from immutable variables are still classified as atomic expressions but reads from mutable variables are classified as complex. Thus, remove_complex_operands yields the following program:

```
(let ([x 2])
(let ([y 0])
(let ([t1 x])
(let ([t2 (begin (set! x 40) x)])
(let ([t3 (+ t1 t2)])
(+ y t3))))))
```

The temporary variable t1 gets the value of x before the set!, so it is 2. The


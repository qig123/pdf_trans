# 7.8 Select Instructions and the x86Defcallq* Language

![Figure 7.9...](images/page_152_vector_300.png)
*Figure 7.9*

7.8 Select Instructions and the x86Def callq∗Language

The output of select instructions is a program in the x86Def callq∗language; the definition of its concrete syntax is shown in figure 7.9, and the definition of its abstract syntax is shown in figure 7.10. We use the align directive on the labels of function definitions to make sure the bottom three bits are zero, which we put to use in chapter 9. We discuss the new instructions as needed in this section. An assignment of a function reference to a variable becomes a load-effective- address instruction as follows, where lhs′ is the translation of lhs from atm in CFun to arg in x86Var,Def callq∗. The FunRef becomes a Global AST node, whose concrete syntax is instruction-pointer-relative addressing.

lhs = (fun-ref f n); ⇒ leaq f(%rip), lhs′

Regarding function definitions, we need to remove the parameters and instead perform parameter passing using the conventions discussed in section 7.2. That is, the arguments are passed in registers. We recommend turning the parameters into local variables and generating instructions at the beginning of the function to move from the argument-passing registers (section 7.2.1) to these local variables.

(Def f '([x1 : T1] [x2 : T2] … ) Tr info B) ⇒ (Def f '() 'Integer info′ B′)

![Figure 7.10...](images/page_153_vector_335.png)
*Figure 7.10*

The basic blocks B′ are the same as B except that the start block is modified to add the instructions for moving from the argument registers to the parameter variables. So the start block of B shown on the left of the following is changed to the code on the right:

fstart: movq %rdi, x1 movq %rsi, x2 · · · instr1 · · · instrn

start: instr1 · · · instrn

⇒

Recall that we use the label start for the initial block of a program, and in section 2.7 we recommend labeling the conclusion of the program with conclusion, so that (Return Arg) can be compiled to an assignment to rax followed by a jump to conclusion. With the addition of function definitions, there is a start block and conclusion for each function, but their labels need to be unique. We recommend prepending the function’s name to start and conclusion, respectively, to obtain unique labels. The interpreter for x86Def callq∗needs to be given the number of parameters the func- tion expects, but the parameters are no longer in the syntax of function definitions.


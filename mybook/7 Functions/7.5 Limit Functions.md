# 7.5 Limit Functions

7.3 Shrink LFun

The shrink pass performs a minor modification to ease the later passes. This pass introduces an explicit main function that gobbles up all the top-level statements of the module. It also changes the top ProgramDefsExp form to ProgramDefs.

(ProgramDefsExp info (def … ) exp) ⇒(ProgramDefs info (def … mainDef))

where mainDef is

(Def 'main '() 'Integer '() exp′)

7.4 Reveal Functions and the LFunRef Language

The syntax of LFun is inconvenient for purposes of compilation in that it conflates the use of function names and local variables. This is a problem because we need to compile the use of a function name differently from the use of a local variable. In particular, we use leaq to convert the function name (a label in x86) to an address in a register. Thus, we create a new pass that changes function references from (Var f) to (FunRef f n) where n is the arity of the function. This pass is named reveal_functions and the output language is LFunRef. Placing this pass after uniquify will make sure that there are no local variables and functions that share the same name. The reveal_functions pass should come before the remove_complex_operands pass because function references should be categorized as complex expressions.

7.5 Limit Functions

Recall that we wish to limit the number of function parameters to six so that we do not need to use the stack for argument passing, which makes it easier to implement efficient tail calls. However, because the input language LFun supports arbitrary numbers of function arguments, we have some work to do! The limit_functions pass transforms functions and function calls that involve more than six arguments to pass the first five arguments as usual, but it packs the rest of the arguments into a tuple and passes it as the sixth argument.1

Each function definition with seven or more parameters is transformed as follows:

(Def f ([x1:T1] … [xn:Tn]) Tr info body) ⇒ (Def f ([x1:T1] … [x5:T5] [tup : (Vector T6 … Tn)]) Tr info body′)

where the body is transformed into body′ by replacing the occurrences of each parameter xi where i > 5 with the kth element of the tuple, where k = i −6.

* The implementation this pass can be postponed to last because you can test the rest of the
  passes on functions with six or fewer parameters.

